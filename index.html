<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar Procedimento</title>

    <!-- Incluindo bibliotecas jsPDF e QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <!-- Incluindo a biblioteca HTML5 QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <!-- Arquivo JS -->
    <script src="/script.js" defer></script>
    
    <script>
    function lerQRCode() {
    const qrReaderElement = document.getElementById("qr-reader");
    qrReaderElement.style.display = "block"; // Mostrar o leitor de QR code

    const html5QrCode = new Html5Qrcode("qr-reader");
    let leituraEfetuada = false; // Flag para garantir que só uma leitura seja registrada

    html5QrCode.start(
        { facingMode: "environment" },  // Câmera traseira
        {
            fps: 10,  // Taxa de quadros
            qrbox: { width: 250, height: 250 }  // Tamanho da caixa de leitura
        },
        qrCodeMessage => {
            if (!leituraEfetuada) {
                leituraEfetuada = true; // Marca como já lido para evitar múltiplas leituras

                console.log("Valor do QR Code:", qrCodeMessage); // Debug para verificar o valor lido

                fetch('/leitura', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ qrCodeMessage })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message); // Exibe mensagem de sucesso
                        // Redirecionar para a página de comprovante
                        window.location.href = `/comprovante?procedimento=${qrCodeMessage}`;
                    } else {
                        alert("Erro: " + data.message); // Exibe mensagem de erro
                    }
                    html5QrCode.stop(); // Para o leitor de QR code
                    qrReaderElement.style.display = "none"; // Esconder o leitor
                })
                .catch(error => {
                    console.error('Erro ao registrar leitura:', error);
                    alert('Erro ao registrar leitura. Tente novamente.');
                    html5QrCode.stop();
                    qrReaderElement.style.display = "none";
                });
            }
        },
        errorMessage => {
            console.log(`Erro ao ler QR Code: ${errorMessage}`);
        }
    ).catch(err => {
        console.log(`Erro ao iniciar a câmera: ${err}`);
    });
}

</script>

</head>
<body>
    <!-- Formulário de Login/Cadastro -->
    <div id="auth-container">
        <h2>Login ou Cadastro</h2>
        <form id="auth-form">
            <label for="username">Usuário:</label>
            <input type="text" id="username" name="username" required>
            <label for="password">Senha:</label>
            <input type="password" id="password" name="password" required>
            <button type="button" onclick="login()">Entrar</button>
            <button type="button" onclick="register()">Cadastrar</button>
        </form>
    </div>

    <!-- Interface após login -->
    <div id="app-container" style="display: none;">
        <h1>Bem-vindo, <span id="user-name"></span></h1>
        <form id="formulario">
            <label for="procedimento">Número do Procedimento:</label>
            <input type="text" id="procedimento" name="procedimento" required>
            <button type="button" onclick="gerarPDF()">Gerar PDF</button>
            <button type="button" onclick="lerQRCode()">Ler QR Code</button>
        </form>
        <div id="qr-reader" style="width: 500px; display: none;"></div>
    </div>
</body>
</html>
